"""
	Little script to extract cleanware from a database into a directory DIR_NAME
    API : https://github.com/KosyanMedia/kyotocabinet-python/blob/master/kyotocabinet-doc.py
    Link DB : https://zenodo.org/record/2528209#.X4RHw5o685k

	Author: Charles-Henry Bertrand Van Ouytsel
	Date : June 2021
"""

from kyotocabinet import *
import sys


DIR_NAME ="Cleanwares"


# create the database object
db = DB()
# open the database
if not db.open("portablefreeware03012919.kch", DB.OWRITER | DB.OCREATE):
    print("open error: " + str(db.error()), file=sys.stderr)

all_index = db.get_str("index")
all_index = all_index.split('\n')

for i in range(1100):
    name = all_index[i].split('\t')[0]
    f = open(DIR_NAME+'/'+name+'.exe','wb')

    file_content = db.get(name)

    #offset ?bizzare? dans la DB (repérable grâce au PE header décalé)
    f.write(file_content[5:])
    f.close()
"""
# traverse records
cur = db.cursor()
cur.jump()
print(cur)
f = open('test.exe','wb')
first = False
while True:
    import pdb; pdb.set_trace()
    rec = cur.get_str(True)
    if first :
        f.write(rec[1])
        first  = False
        f.close()
    if not rec: break
    print(rec[0] + ":" + rec[1])
cur.disable()
"""
# close the database
if not db.close():
    print("close error: " + str(db.error()), file=sys.stderr)
